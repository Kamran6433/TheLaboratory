import{_ as G,e as R,s as j,R as z,r as b,f as M,am as P,U as O,W as Y,X as V,af as q,ag as H,ah as J,ai as W,G as A,o as r,h as u,w as a,b as l,m as X,p as x,j as K,a as i,c as m,F as _,O as E,D as Q,t as c,V as I,l as k,i as U,E as Z,k as S,A as D,d as g,I as y,z as ee,B}from"./j--dK8i6.js";const te={class:"text-4xl md:text-5xl font-bold ml-8 mt-16 mb-4"},se={class:"mb-4"},ae={class:"text-sm font-medium text-gray-500 uppercase"},le={class:"mt-1 text-base md:text-lg font-semibold text-gray-900"},oe={key:0,class:"px-4"},re={class:"d-flex align-center"},ie={class:"text-xl font-bold"},ne={class:"mb-4"},ue={class:"text-sm font-medium text-gray-500 uppercase"},ce={class:"mt-1 text-base md:text-lg font-semibold text-gray-900"},de={key:0,class:"mt-6"},me={__name:"UserProfile",setup(N){const p=R(),{getUser:C,getIsCustomer:be,getStripeCustomerId:ge,getEmail:$,getEmailVerified:T}=j(p),h=z(),o=b({name:"",email:"",number:"",school:"",isCustomer:!1}),t=b({subscriptionId:null,subscriptionStatus:null,subscriptionEndDate:null,lastPaymentDate:null,lastPaymentAmount:null}),v=b(!0),d=b(null);M(async()=>{try{let s=P.currentUser;if(s){if(await s.reload(),s=P.currentUser,!s.emailVerified){h.push("/verify-email");return}try{const e=await O(Y(V,"users",s.uid));if(e.exists()){if(o.value=e.data(),o.value.email=$.value,o.value.emailVerified=T.value,p.updateUser(o.value),o.value.isCustomer){const n=await q(H(J(V,"stripeCustomers"),W("userId","==",s.uid)));n.empty||(t.value=n.docs[0].data(),p.updateUser(t.value))}}else d.value="User profile not found"}catch(e){if(e.code==="permission-denied")h.push("/verify-email");else throw e}}else d.value="User not authenticated",h.push("/login")}catch(s){console.error("Error fetching user profile:",s),d.value="Error loading profile. Please try again."}finally{v.value=!1}});const w=async()=>{v.value=!0;try{const s=await fetch("/api/stripe-subscription-cancel-session",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:C.value.uid,subscriptionId:t.value.subscriptionId})});if(!s.ok){const n=await s.text();throw new Error(`HTTP error! status: ${s.status}, message: ${n}`)}const e=await s.json();if(e.success)t.value.subscriptionStatus="cancelling",t.value.subscriptionEndDate=e.endDate,t.value.cancellationScheduledAt=e.cancellationScheduledAt,p.updateUser({subscriptionStatus:"cancelling",subscriptionEndDate:e.endDate,cancellationScheduledAt:e.cancellationScheduledAt}),alert(e.message);else throw new Error(e.message||"Failed to cancel subscription")}catch(s){console.error("Error cancelling subscription:",s),d.value=`Failed to cancel subscription: ${s.message}`}finally{v.value=!1}},L=A(()=>({Email:o.value.email,Phone:o.value.number,School:o.value.school,"Customer Status":o.value.isCustomer?"Stripe Customer":"Not a Stripe Customer"})),F=A(()=>{const s={Status:t.value.subscriptionStatus,"Subscription ID":t.value.subscriptionId,"Plan Name":t.value.subscriptionPlanName||"Default Plan","Plan Amount":t.value.planAmount?`£${(t.value.planAmount/100).toFixed(2)}`:"N/A","Billing Interval":t.value.planInterval||"Monthly"};return t.value.lastPaymentDate&&(s["Last Payment Date"]=new Date(t.value.lastPaymentDate.seconds*1e3).toLocaleDateString("en-GB",{day:"numeric",month:"long",year:"numeric"}),s["Last Payment Amount"]=`£${(t.value.lastPaymentAmount/100).toFixed(2)}`),t.value.subscriptionStatus==="cancelling"&&(t.value.cancellationScheduledAt&&(s["Cancellation Date"]=new Date(t.value.cancellationScheduledAt.seconds*1e3).toLocaleDateString("en-GB",{day:"numeric",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"})),t.value.subscriptionEndDate&&(s["Access Until"]=new Date(t.value.subscriptionEndDate.seconds*1e3).toLocaleDateString("en-GB",{day:"numeric",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"}))),s});return(s,e)=>(r(),u(B,{fluid:"",class:"max-width-1600 py-24 px-4 px-lg-12 d-flex align-center min-height-100"},{default:a(()=>[l(X,{class:"user-profile mx-auto rounded-lg overflow-hidden","max-width":"700"},{default:a(()=>[v.value?(r(),u(x,{key:0,class:"text-center py-12"},{default:a(()=>[l(K,{indeterminate:"",color:"primary",size:"64"}),e[0]||(e[0]=i("p",{class:"mt-4 text-lg text-gray-600"}," Loading profile... ",-1))]),_:1})):d.value?(r(),u(x,{key:2},{default:a(()=>[l(S,{type:"error",class:"mb-0"},{default:a(()=>[g(c(d.value),1)]),_:1})]),_:1})):(r(),m(_,{key:1},[l(E,{height:"200",src:"https://picsum.photos/700/200?random",class:"bg-gray-100"},{default:a(()=>[l(Q,{class:"mt-32 ml-6",size:"128",style:{border:"4px solid white"}},{default:a(()=>[l(E,{src:`https://avatars.dicebear.com/api/initials/${o.value.name}.svg`},null,8,["src"])]),_:1})]),_:1}),i("h1",te,c(o.value.name),1),l(x,null,{default:a(()=>[l(I,{class:"px-4"},{default:a(()=>[(r(!0),m(_,null,k(L.value,(n,f)=>(r(),u(U,{key:f,cols:"12",sm:"6"},{default:a(()=>[i("div",se,[i("p",ae,c(f),1),i("p",le,c(n),1)])]),_:2},1024))),128))]),_:1}),l(Z,{class:"my-6"}),o.value.isCustomer?(r(),m("div",oe,[e[3]||(e[3]=i("h1",{class:"text-2xl md:text-3xl font-bold mb-4"}," Subscription Information ",-1)),l(S,{type:t.value.subscriptionStatus==="active"?"success":"warning",class:"mb-4"},{default:a(()=>[i("div",re,[i("p",ie,c(t.value.subscriptionStatus==="active"?"Active Subscription":"Subscription Cancelling"),1)])]),_:1},8,["type"]),l(I,null,{default:a(()=>[(r(!0),m(_,null,k(F.value,(n,f)=>(r(),u(U,{key:f,cols:"12",sm:"6",class:"subscription-info"},{default:a(()=>[i("div",ne,[i("p",ue,c(f),1),i("p",ce,c(n),1)])]),_:2},1024))),128))]),_:1}),t.value.subscriptionStatus==="active"?(r(),m("div",de,[l(D,{color:"error",class:"text-base",onClick:w},{default:a(()=>e[1]||(e[1]=[g(" Cancel Subscription ")])),_:1})])):y("",!0),t.value.subscriptionStatus==="cancelling"?(r(),u(S,{key:1,type:"info",class:"mt-4"},{default:a(()=>e[2]||(e[2]=[i("p",{class:"text-xl font-bold"}," Your subscription will remain active until the end date. You'll continue to have full access to all features until then. ",-1)])),_:1})):y("",!0)])):y("",!0)]),_:1}),l(ee,{class:"px-6 pb-6"},{default:a(()=>[l(D,{color:"primary",to:"/profile/update",class:"mr-2 text-base"},{default:a(()=>e[4]||(e[4]=[g(" Manage Profile ")])),_:1}),o.value.isCustomer&&t.value.subscriptionStatus==="active"?(r(),u(D,{key:0,color:"error",class:"text-base",onClick:w},{default:a(()=>e[5]||(e[5]=[g(" Cancel Subscription ")])),_:1})):y("",!0)]),_:1})],64))]),_:1})]),_:1}))}},pe=G(me,[["__scopeId","data-v-7095e7e4"]]),fe={class:"max-width-1600 py-0 py-lg-8"},ve={class:"box3 hero"},he={__name:"user",setup(N){return(p,C)=>(r(),m("div",fe,[i("section",ve,[l(B,{class:"box1 pa-2","data-aos":"fade-up","data-aos-duration":"300"},{default:a(()=>[l(pe)]),_:1})])]))}};export{he as default};
//# sourceMappingURL=CNpzIRzM.js.map
